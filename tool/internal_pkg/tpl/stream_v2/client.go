package stream_v2

var ClientTpl = `// Code generated by Kitex {{.Version}}. DO NOT EDIT.

package {{ToLower .ServiceName}}

import (
	{{- range $path, $aliases := .Imports}}
		{{- if not $aliases}}
			"{{$path}}"
		{{- else}}
			{{- range $alias, $is := $aliases}}
				{{$alias}} "{{$path}}"
			{{- end}}
		{{- end}}
	{{- end}}
	"github.com/cloudwego/kitex/client/streamxclient"
	"github.com/cloudwego/kitex/client/streamxclient/streamxcallopt"
    "github.com/cloudwego/kitex/streamx"
    ttheader "github.com/cloudwego/kitex/streamx/provider/ttstream"
)
{{- $protocol := .Protocol}}

type ClientStreamingClient[Req, Res any] streamx.ClientStreamingClient[{{$protocol}}.Header, {{$protocol}}.Trailer, Req, Res]
type ServerStreamingClient[Res any] streamx.ServerStreamingClient[{{$protocol}}.Header, {{$protocol}}.Trailer, Res]
type BidiStreamingClient[Req, Res any] streamx.BidiStreamingClient[{{$protocol}}.Header, {{$protocol}}.Trailer, Req, Res]

type ClientInterface interface {
{{- range .AllMethods}}
{{- $unary := and (not .ServerStreaming) (not .ClientStreaming)}}
{{- $clientSide := and .ClientStreaming (not .ServerStreaming)}}
{{- $serverSide := and (not .ClientStreaming) .ServerStreaming}}
{{- $bidiSide := and .ClientStreaming .ServerStreaming}}
{{- $arg := index .Args 0}}
    {{.Name}}{{- if $unary}}(ctx context.Context, req {{$arg.Type}}, callOptions ...streamxcallopt.CallOption) (r {{.Resp.Type}}, err error)
             {{- else if $clientSide}}(ctx context.Context, callOptions ...streamxcallopt.CallOption) (stream ClientStreamingClient[{{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}], err error)
             {{- else if $serverSide}}(ctx context.Context, req {{$arg.Type}}, callOptions ...streamxcallopt.CallOption) (stream ServerStreamingClient[{{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}], err error)
             {{- else if $bidiSide}}(ctx context.Context, callOptions ...streamxcallopt.CallOption) (stream BidiStreamingClient[{{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}], err error)
             {{- end}}
{{- end}}
}

func NewClient(destService string, opts ...streamxclient.ClientOption) (ClientInterface, error) {
	var options []streamxclient.ClientOption
	options = append(options, streamxclient.WithDestService(destService))
	options = append(options, opts...)
	cp, err := {{$protocol}}.NewClientProvider(serviceInfo)
	if err != nil {
		return nil, err
	}
	options = append(options, streamxclient.WithProvider(cp))
	cli, err := streamxclient.NewClient(serviceInfo, options...)
	if err != nil {
		return nil, err
	}
	kc := &kClient{ClientStreamProvider: cli}
	return kc, nil
}

var _ ClientInterface = (*kClient)(nil)

var kClient struct {
    streamx.ClientStreamProvider
}

{{- range .AllMethods}}
{{- $unary := and (not .ServerStreaming) (not .ClientStreaming)}}
{{- $clientSide := and .ClientStreaming (not .ServerStreaming)}}
{{- $serverSide := and (not .ClientStreaming) .ServerStreaming}}
{{- $bidiSide := and .ClientStreaming .ServerStreaming}}
{{- $mode := ""}}
	{{- if $bidiSide -}} {{- $mode = "serviceinfo.StreamingBidirectional" }}
	{{- else if $serverSide -}} {{- $mode = "serviceinfo.StreamingServer" }}
	{{- else if $clientSide -}} {{- $mode = "serviceinfo.StreamingClient" }}
	{{- else if $unary -}} {{- $mode = "serviceinfo.StreamingUnary" }}
    {{- end}}
{{- $arg := index .Args 0}}
func (c *kClient) {{.Name}}{{- if $unary}}(ctx context.Context, req {{$arg.Type}}, callOptions ...streamxcallopt.CallOption) ({{.Resp.Type}}, error) {
    res := new({{NotPtr .Resp.Type}})
    _, err := streamx.ClientInvoke[{{$protocol}}.Header, {{$protocol}}.Trailer, {{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}](
        ctx, c, {{$mode}}, {{.RawName}}, req, res, callOptions...)
    if err != nil {
        return nil, err
    }
    return res, nil
{{- else if $clientSide}}(ctx context.Context, callOptions ...streamxcallopt.CallOption) (stream ClientStreamingClient[{{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}], err error) {
    return streamx.ClientInvoke[{{$protocol}}.Header, {{$protocol}}.Trailer, {{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}](
        ctx, c, {{$mode}}, {{.RawName}}, nil, nil, callOptions...)
{{- else if $serverSide}}(ctx context.Context, req {{$arg.Type}}, callOptions ...streamxcallopt.CallOption) (stream ServerStreamingClient[{{.PkgRefName}}.{{.ArgStructName}}, {{.PkgRefName}}.{{.ResStructName}}], err error) {
    return streamx.ClientInvoke[{{$protocol}}.Header, {{$protocol}}.Trailer, {{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}](
        ctx, c, {{$mode}}, {{.RawName}}, req, nil, callOptions...)
{{- else if $bidiSide}}(ctx context.Context, callOptions ...streamxcallopt.CallOption) (stream BidiStreamingClient[{{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}], err error) {
    return streamx.ClientInvoke[{{$protocol}}.Header, {{$protocol}}.Trailer, {{NotPtr $arg.Type}}, {{NotPtr .Resp.Type}}](
        ctx, c, {{$mode}}, {{.RawName}}, nil, nil, callOptions...)
{{- end}}
}
{{- end}}
`
